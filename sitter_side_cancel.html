<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upcoming Jobs</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">

    <style>
      #page_body {
          /* font-family: 'Lato', sans-serif; */
          background-image: url('Pets/pets.jpg');
          background-size: cover;
          background-repeat: no-repeat;
          color: #191a1e;
      }
  </style>

</head>
<body id="page_body">    
  
    <div class="container bg-light my-5">
        <h1 class="display-1 text-center fw-bold">Job Sessions</h1>
        <p class="text-center fs-3">View and manage upcoming jobs that you have currently accepted, and view all previous sessions that were completed or cancelled.</p>

        <div id="filter">
          <!-- <div class="form-check">
            <input class="form-check-input" type="radio" value="In Progress" id="upcoming">
            <label class="form-check-label">
              Upcoming
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" value="Completed" id="completed">
            <label class="form-check-label">
              Completed
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" value="Cancelled" id="cancelled">
            <label class="form-check-label">
              Cancelled
            </label>
          </div> -->
            
          <button class="btn btn-info" onclick="viewJobs('In Progress')">Upcoming Jobs</button>
          <button class="btn btn-success" onclick="viewJobs('Completed')">Completed Jobs</button>
          <button class="btn btn-danger" onclick="viewJobs('Cancelled')">Cancelled Jobs</button>
        </div>
        
        <div class="row my-3" id="job_list">
          

        </div>
    
        
      

    </div>

    <script>

      // need to send over session id for session rejection

      // const sitter_rejection_url = "http://localhost:5200/incident_handling";
      // var session_id = "642943d606864f6b8cac1f46";

      // fetch(`${sitter_rejection_url}/${session_id}`)
      // .then(response => response.js())
      // .then(data => {
      //   console.log(response);
      // })
      // .catch(error => {
      //   console.log(error);
      // })

      var sitter_id = '642935cb06864f6b8cac1f39'

      const session_get_url = "http://localhost:5004/sitter_all_sessions";
      const get_job_url = "http://localhost:5005/job";
      var jobs_arr = [];
      var status_arr = [];
      var jobs_id_arr = [];
      // temp_jobs_status = {};

      const fetch_sessions = 
      fetch(`${session_get_url}/${sitter_id}`)
      .then(response => response.json())
      .then(data => {
        // console.log(fetch_sessions);
        // console.log(data);

        
        var temp_job_arr = []
        var curr_sessions = data.data;
        for (let index = 0; index < curr_sessions.length; index++) {
          var curr_session = curr_sessions[index];
          console.log(curr_session);
          var job_id = curr_session["JobID"]["$oid"];
          var status = curr_session["status"];
          console.log(job_id, status);
          // temp_jobs_status[`${get_job_url}/${job_id}`] = status;
          const fetch_jobs = fetch(`${get_job_url}/${job_id}`)
          .then(response => response.json())
          .then(data => {
            temp_job_arr.push(data.data)
            update_job_arr(temp_job_arr);
          })


          // jobs_arr.push(`${get_job_url}/${job_id}`)
          status_arr.push(status)
          jobs_id_arr.push(job_id)
        }
         

        // console.log(temp_jobs_status);
        // console.log(jobs_arr);
        // console.log(status_arr); 
        // jobs = temp_jobs_status
        // console.log(jobs);

        updateArr(status_arr, jobs_id_arr);

      
        // populate_data(jobs_arr, status_arr)
      })

      function viewJobs(curr_filter) {
        // console.log(jobs_arr, status_arr, jobs_id_arr);

        document.getElementById("job_list").innerHTML = ""
        for (let index = 0; index < jobs_arr.length; index++) {
          curr_status = status_arr[index]
          curr_job = jobs_arr[index][0]
          // console.log(curr_job);
          curr_id = jobs_id_arr[index]

          if (curr_status == curr_filter) {
            console.log(curr_job);
            var job_num = `job${index+1}`
            
            var job_title = curr_job["Title"];
            var job_desc = curr_job["Description"];
            var image = curr_job["Image_Path"]
            var start_time = Number(curr_job["Start_datetime"]);
            var end_time = Number(curr_job["End_datetime"]);
            var status = curr_job["Status"]
            var hourly_rate = curr_job["Hourly_rate"]["$numberDecimal"]

            var start_format_date = new Date(start_time).toLocaleDateString("en-US");
            var start_format_time = new Date(start_time).toLocaleTimeString("en-SG");
            var end_format_date = new Date(end_time).toLocaleDateString("en-SG");
            var end_format_time = new Date(end_time).toLocaleTimeString("en-SG");

            // console.log(job_title, job_desc, image, start_format_date, start_format_time, end_format_date, end_format_time, status, hourly_rate);
            var temp_str = 
            `
            <div class="col-4 my-2" id="${curr_id}">
              <div class="card h-100">
                <img src="${image}" class="card-img-top">
                <div class="card-body">
                    <h5 class="card-title">${job_title}</h5>
                    <p class="card-text">${job_desc}</p>
                    <!-- View More Jobs Modal -->
                    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#${job_num}Modal">
                        View More Info
                    </button>
                    <!-- Modal -->
                    <div class="modal fade" id="${job_num}Modal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                <h1 class="modal-title fs-5" id="jobModalLabel">${job_title}</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                  <p>Job Description: ${job_desc}</p>
                                  <p>Starting Date & Time: ${start_format_date} ${start_format_time}</p>
                                  <p>Ending Date & Time: ${end_format_date} ${end_format_time}</p>
                                  <p>Hourly Rate: $${hourly_rate}/hr</p>
                                </div>
                                <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>`

            if (curr_status == "In Progress") {
              temp_str += 
              `
              <!-- Cancel Job -->
              <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#cancel${job_num}Modal">
                  Cancel Job
              </button>
              <!-- Modal -->
              <div class="modal fade" id="cancel${job_num}Modal" tabindex="-1">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h1 class="modal-title fs-5" id="cancelJobModalLabel">Cancel Job?</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      Are you sure you want to cancel this Job? Note that cancellation of this job at this current period will result in a $20 penalty credited from your bank account. Failure to pay the penalty amount will result in your account being locked out.
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-danger" onclick="removeJob(${curr_id})" id="job_cancel1">Cancel</button>
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Don't Cancel</button>
                    </div>
                  </div>
                </div>
              </div>
              `
            }
            else if(curr_status == "Completed"){
              temp_str += `<button class="btn btn-success disabled">Completed</button>`
            }
            else{
              temp_str += `<button class="btn btn-danger disabled">Cancelled</button>`
            }

            temp_str +=

            `
                </div>
              </div>
            </div>
            
            `

            document.getElementById("job_list").innerHTML += temp_str
          }
          


          }
        }
      

      function updateArr(temp_status_arr, temp_job_id_arr) {
        status_arr = temp_status_arr
        jobs_id_arr = temp_job_id_arr
        // console.log(jobidi);
      }

      function update_job_arr(temp_job_arr) {
        jobs_arr = temp_job_arr;
      }
  


      // function removeJob(job) {
      //     var job_id = job.id.substr(job.id.length-1,1)
      //     var job_to_remove = document.getElementById(`job${job_id}`)
      //     job_to_remove.remove()
      //     location.reload()
      // }


    </script>




    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>

    <!-- MDB -->
    <!-- <script
    type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.2.0/mdb.min.js"
    ></script> -->
</body>
</html>


